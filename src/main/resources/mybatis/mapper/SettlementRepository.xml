<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aaa.huahui.repository.SettlementRepository">


    <resultMap id="SettlementVO" type="com.aaa.huahui.vo.SettlementVO">

        <id column="settlementid" property="id"/>
        <result column="shopid" property="shopid"/>
        <result column="createtime" property="createtime"/>
        <result column="customername" property="customername"/>
        <result column="paymentmethodname" property="paymentmethod"/>
        <result column="consultant" property="consultant"/>
        <result column="roomname" property="roomname"/>


        <collection property="settlementItems" ofType="com.aaa.huahui.vo.SettlementItemVO">
            <result property="settlementid" column="settlementid" javaType="int"/>
            <result property="id" column="settlementitemid" javaType="int"/>
            <result property="category2name" column="category2name" javaType="string"/>
            <result property="times" column="times" javaType="int"/>
            <result property="price" column="price" javaType="int"/>
            <result property="staff1name" column="staff1name" javaType="string"/>
            <result property="staff2name" column="staff2name" javaType="string"/>
        </collection>

    </resultMap>


    <select id="selectSettlementById" resultMap="SettlementVO">


    select settlement.id           settlementid,
           settlement.shopid       shopid,
           settlement.roomname     roomname,
           settlement.createtime   createtime,
           settlement.customername customername,
           paymentmethod.name      paymentmethodname,

           consultanttable.name    consultant,

           settlementitem.id       settlementitemid,
           settlementitem.times    times,
           settlementitem.price    price,

           category2.name          category2name,

           staff1.name             staff1name,
           staff2.name             staff2name

    from settlementitem settlementitem
             left join
         settlement settlement on settlement.id = settlementitem.settlementid
             left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
             left join staff consultanttable
                       on consultanttable.staffid = settlement.consultantid and consultanttable.role = 'consultant'
             left join staff staff1 on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
             left join staff staff2 on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
             left join category2 category2 on category2.category2id = settlementitem.category2id

            where settlement.id = #{id}

        </select>


    <select id="selectSettlementByIdWithPage" resultMap="SettlementVO">

    select settlement.id           settlementid,
           settlement.shopid       shopid,
           settlement.roomname     roomname,
           settlement.createtime   createtime,
           settlement.customername customername,
           paymentmethod.name      paymentmethodname,

           consultanttable.name    consultant,

           settlementitem.id       settlementitemid,
           settlementitem.times    times,
           settlementitem.price    price,

           category2.name          category2name,

           staff1.name             staff1name,
           staff2.name             staff2name

    from settlementitem settlementitem
             left join
         settlement settlement on settlement.id = settlementitem.settlementid
             left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
             left join staff consultanttable
                       on consultanttable.staffid = settlement.consultantid and consultanttable.role = 'consultant'
             left join staff staff1 on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
             left join staff staff2 on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
             left join category2 category2 on category2.category2id = settlementitem.category2id

    where settlement.shopid = #{shopid}
      and settlement.createtime between #{from} and #{to}
    order by createtime desc
    limit #{offset},#{limit}

    </select>

    <select id="selectCountCustomerTimes" resultType="java.util.Map">

    select customername, count(customername) count
    from settlement
    where shopid = #{shopid}
      and settlement.createtime between #{from} and #{to}
      group by customername
    order by count desc
    </select>


    <select id="selectCountCustomerPrice" resultType="java.util.Map">
    select customername, sum(price) countprice
    from (
             select
                    settlement.createtime   createtime,
                    settlement.customername customername,

                    settlementitem.price    price

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod


             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
             order by createtime desc
         ) t
    group by customername
    order by countprice desc ;
    </select>


    <select id="selectCountCustomerGreaterOrEq" resultType="java.lang.Integer">

    select count(customername) count
    from (
             select customername, count(customername) count
             from settlement
             where shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
             group by customername
             order by count
         )t where count>=#{mintimes}
    </select>


    <select id="selectProjectSumPrice" resultType="java.util.Map">

    select projectname, sum(price) sumprice
    from (
             select settlement.createtime createtime,
                    project.name          projectname,
                    settlementitem.price  price
             from settlementitem settlementitem
                      left join settlement settlement on settlement.id = settlementitem.settlementid
                      left join category2 category2 on category2.category2id = settlementitem.category2id
                      left join project on category2.category2id = project.category2id

             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
             order by createtime desc
         ) t
    group by projectname
    order by sumprice desc

    </select>


    <select id="selectProjectCount" resultType="java.util.Map">
    select projectname, count(projectname) projectcount
    from (
             select settlement.createtime createtime,
                    project.name          projectname
             from settlementitem settlementitem
                      left join settlement settlement on settlement.id = settlementitem.settlementid
                      left join category2 category2 on category2.category2id = settlementitem.category2id
                      left join project on category2.category2id = project.category2id

             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
             order by createtime desc
         ) t
    group by projectname
    order by projectcount desc
    </select>

    <select id="selectProjectBeauticianCount" resultType="java.util.Map">


    </select>
    <select id="selectCategory2SumPrice" resultType="java.util.Map">
    select category2name, sum(price) sumprice
    from (
             select
                    settlementitem.price    price,
                    category2.name          category2name

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                      left join staff consultanttable
                                on consultanttable.staffid = settlement.consultantid and
                                   consultanttable.role = 'consultant'
                      left join staff staff1
                                on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                      left join staff staff2
                                on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                      left join category2 category2 on category2.category2id = settlementitem.category2id


             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
         ) t
    group by category2name

    </select>

    <select id="selectCategory2SumCount" resultType="java.util.Map">
    select category2name, count (category2name) sumcount
    from (
             select
                    settlementitem.price    price,
                    category2.name          category2name

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                      left join staff consultanttable
                                on consultanttable.staffid = settlement.consultantid and
                                   consultanttable.role = 'consultant'
                      left join staff staff1
                                on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                      left join staff staff2
                                on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                      left join category2 category2 on category2.category2id = settlementitem.category2id


             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
         ) t
    group by category2name

    </select>


    <select id="selectCategory2SumCountAndSumPrice" resultType="java.util.Map">

    select t1.category2name, sumcount, sumprice
    from (
             select category2name, sum(price) sumprice
             from (
                      select settlementitem.price price,
                             category2.name       category2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id


                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by category2name
         ) t1,
         (
             select category2name, count(category2name) sumcount
             from (
                      select settlementitem.price price,
                             category2.name       category2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id


                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by category2name
         ) t2


    where t1.category2name = t2.category2name

    </select>


    <select id="selectConsultantCategory2SumPrice" resultType="java.util.Map">

    select category2name, sum(price) sumprice
    from (
             select

                 settlementitem.price    price,

                 category2.name          category2name

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                      left join staff consultanttable
                                on consultanttable.staffid = settlement.consultantid and
                                   consultanttable.role = 'consultant' and consultanttable.name=#{consultantname}
                      left join staff staff1
                                on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                      left join staff staff2
                                on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                      left join category2 category2 on category2.category2id = settlementitem.category2id

             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
         ) t
    group by category2name



    </select>


    <select id="selectConsultantCategory2SumCount" resultType="java.util.Map">
    select category2name, count (category2name) countcategory2name
    from (
             select
                 category2.name          category2name

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                      left join staff consultanttable
                                on consultanttable.staffid = settlement.consultantid and
                                   consultanttable.role = 'consultant' and consultanttable.name=#{consultantname}
                      left join staff staff1
                                on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                      left join staff staff2
                                on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                      left join category2 category2 on category2.category2id = settlementitem.category2id

             where settlement.shopid = #{shopid} 
               and settlement.createtime between #{from} and #{to}
         ) t
    group by category2name

    </select>


    <select id="selectConsultantCategory2SumCountAndSumPrice" resultType="java.util.Map">
    select t1.category2name, countcategory2name, sumprice
    from (
             select category2name, count(category2name) countcategory2name
             from (
                      select category2.name category2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant' and consultanttable.name = #{consultantname}
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by category2name
         ) t1,
         (
             select category2name, sum(price) sumprice
             from (
                      select settlementitem.price price,

                             category2.name       category2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant' and consultanttable.name = #{consultantname}
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by category2name
         ) t2
    where t1.category2name = t2.category2name
    </select>


    <select id="selecteauticianCategory2SumPrice" resultType="java.util.Map">
    select category2name, sum(price) sumprice
    from (
             select settlement.createtime createtime,

                    settlementitem.price  price,

                    category2.name        category2name,

                    staff1.name           staff1name,
                    staff2.name           staff2name

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                      left join staff staff1 on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                      left join staff staff2 on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                      left join category2 category2 on category2.category2id = settlementitem.category2id
                      left join project on category2.category2id = project.category2id

             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
             order by createtime desc
         ) t
    where staff1name =#{beauticianname}
       or staff2name =#{beauticianname}
    </select>

    <select id="selectbBeauticianCategory2SumCount" resultType="java.util.Map">

 select category2name, count(category2name) countcategory2name
    from (
             select settlement.createtime createtime,

                    settlementitem.price  price,

                    category2.name        category2name,

                    staff1.name           staff1name,
                    staff2.name           staff2name

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                      left join staff staff1 on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                      left join staff staff2 on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                      left join category2 category2 on category2.category2id = settlementitem.category2id
                      left join project on category2.category2id = project.category2id

             where settlement.shopid = #{shopid}
               and settlement.createtime between #{from} and #{to}
             order by createtime desc
         ) t
    where staff1name =#{beauticianname}
       or staff2name =#{beauticianname}
    </select>


    <select id="selectbBeauticianCategory2SumCountAndSumPrice" resultType="java.util.Map">

    select t1.category2name, countcategory2name, sumprice
    from (select category2name, count(category2name) countcategory2name
          from (
                   select settlement.createtime createtime,

                          settlementitem.price  price,

                          category2.name        category2name,

                          staff1.name           staff1name,
                          staff2.name           staff2name

                   from settlementitem settlementitem
                            left join
                        settlement settlement on settlement.id = settlementitem.settlementid
                            left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                            left join staff staff1 on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                            left join staff staff2 on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                            left join category2 category2 on category2.category2id = settlementitem.category2id
                            left join project on category2.category2id = project.category2id

                   where settlement.shopid = #{shopid}
                     and settlement.createtime between #{from} and #{to}
                   order by createtime desc
               ) t
          where staff1name =#{beauticianname}
        or staff2name  =#{beauticianname}
        group by category2name
        ) t1,
         (
             select category2name, sum(price) sumprice
             from (
                      select settlement.createtime createtime,

                             settlementitem.price  price,

                             category2.name        category2name,

                             staff1.name           staff1name,
                             staff2.name           staff2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id
                               left join project on category2.category2id = project.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                      order by createtime desc
                  ) t
             where staff1name = #{beauticianname}
                or staff2name = #{beauticianname}
                group by category2name
         ) t2
    where t1.category2name = t2.category2name;

    </select>


    <select id="selectbBeauticianCustomer" resultType="java.util.Map">
    select  count(distinct customername) distinctcustomername,
        count(customername) countcustomername,
        (count(customername)) / datediff(20191001, 20190930) passengerflow
    from (
             select settlementitem.price    price,
                    settlement.customername customername

             from settlementitem settlementitem
                      left join
                  settlement settlement on settlement.id = settlementitem.settlementid
                      left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                      left join staff staff1
                                on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                      left join staff staff2
                                on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                      left join category2 category2 on category2.category2id = settlementitem.category2id
                      left join category category on category.id = category2.categoryid and category.name = "产品"

             where settlement.shopid = 12
               and settlement.createtime between 20190101 and 20191001
               and (staff1.name = "dewittshop"
                 or staff2.name = "dewittshop")
    ) t

    </select>


    <select id="selctProductProjectSumPriceAndCount" resultType="java.util.Map">
    select t1.projectname projectname, t1.sumprice sumprice, t2.countprojectname countprojectname
    from (
             select projectname projectname, sum(price) sumprice
             from (
                      select settlement.id           settlementid,
                             settlement.shopid       shopid,
                             settlement.roomname     roomname,
                             settlement.createtime   createtime,
                             settlement.customername customername,
                             paymentmethod.name      paymentmethodname,
                             project.name            projectname,


                             consultanttable.name    consultant,

                             settlementitem.id       settlementitemid,
                             settlementitem.times    times,
                             settlementitem.price    price,

                             category2.name          category2name,

                             staff1.name             staff1name,
                             staff2.name             staff2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id
                               left join category category on category.id = category2.categoryid and category.name = "产品"

                               left join project on category2.category2id = project.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by t.projectname
         ) t1,
         (
             select projectname projectname, count(projectname) countprojectname
             from (
                      select settlement.id           settlementid,
                             settlement.shopid       shopid,
                             settlement.roomname     roomname,
                             settlement.createtime   createtime,
                             settlement.customername customername,
                             paymentmethod.name      paymentmethodname,
                             project.name            projectname,


                             consultanttable.name    consultant,

                             settlementitem.id       settlementitemid,
                             settlementitem.times    times,
                             settlementitem.price    price,

                             category2.name          category2name,

                             staff1.name             staff1name,
                             staff2.name             staff2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id
                               left join project on category2.category2id = project.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by t.projectname
         ) t2
    where t1.projectname = t2.projectname
    order by sumprice, countprojectname

    </select>





    <select id="selctBeautyProjectSumPriceAndCount" resultType="java.util.Map">

         select t1.projectname projectname, t1.sumprice sumprice, t2.countprojectname countprojectname
    from (
             select projectname projectname, sum(price) sumprice
             from (
                      select settlement.id           settlementid,
                             settlement.shopid       shopid,
                             settlement.roomname     roomname,
                             settlement.createtime   createtime,
                             settlement.customername customername,
                             paymentmethod.name      paymentmethodname,
                             project.name            projectname,


                             consultanttable.name    consultant,

                             settlementitem.id       settlementitemid,
                             settlementitem.times    times,
                             settlementitem.price    price,

                             category2.name          category2name,

                             staff1.name             staff1name,
                             staff2.name             staff2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id and category2.name="美容"
                               left join project on category2.category2id = project.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by t.projectname
         ) t1,
         (
             select projectname projectname, count(projectname) countprojectname
             from (
                      select settlement.id           settlementid,
                             settlement.shopid       shopid,
                             settlement.roomname     roomname,
                             settlement.createtime   createtime,
                             settlement.customername customername,
                             paymentmethod.name      paymentmethodname,
                             project.name            projectname,


                             consultanttable.name    consultant,

                             settlementitem.id       settlementitemid,
                             settlementitem.times    times,
                             settlementitem.price    price,

                             category2.name          category2name,

                             staff1.name             staff1name,
                             staff2.name             staff2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id and category2.name="美容"
                               left join project on category2.category2id = project.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by t.projectname
         ) t2
    where t1.projectname = t2.projectname
    order by sumprice, countprojectname

    </select>






    <select id="selctBodyProjectSumPriceAndCount" resultType="java.util.Map">

         select t1.projectname projectname, t1.sumprice sumprice, t2.countprojectname countprojectname
    from (
             select projectname projectname, sum(price) sumprice
             from (
                      select settlement.id           settlementid,
                             settlement.shopid       shopid,
                             settlement.roomname     roomname,
                             settlement.createtime   createtime,
                             settlement.customername customername,
                             paymentmethod.name      paymentmethodname,
                             project.name            projectname,


                             consultanttable.name    consultant,

                             settlementitem.id       settlementitemid,
                             settlementitem.times    times,
                             settlementitem.price    price,

                             category2.name          category2name,

                             staff1.name             staff1name,
                             staff2.name             staff2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id and category2.name="美体"
                               left join project on category2.category2id = project.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by t.projectname
         ) t1,
         (
             select projectname projectname, count(projectname) countprojectname
             from (
                      select settlement.id           settlementid,
                             settlement.shopid       shopid,
                             settlement.roomname     roomname,
                             settlement.createtime   createtime,
                             settlement.customername customername,
                             paymentmethod.name      paymentmethodname,
                             project.name            projectname,


                             consultanttable.name    consultant,

                             settlementitem.id       settlementitemid,
                             settlementitem.times    times,
                             settlementitem.price    price,

                             category2.name          category2name,

                             staff1.name             staff1name,
                             staff2.name             staff2name

                      from settlementitem settlementitem
                               left join
                           settlement settlement on settlement.id = settlementitem.settlementid
                               left join paymentmethod paymentmethod on paymentmethod.id = settlement.paymentmethod
                               left join staff consultanttable
                                         on consultanttable.staffid = settlement.consultantid and
                                            consultanttable.role = 'consultant'
                               left join staff staff1
                                         on staff1.staffid = settlementitem.staff1 and staff1.role = 'beautician'
                               left join staff staff2
                                         on staff2.staffid = settlementitem.staff2 and staff1.role = 'beautician'
                               left join category2 category2 on category2.category2id = settlementitem.category2id and category2.name="美体"
                               left join project on category2.category2id = project.category2id

                      where settlement.shopid = #{shopid}
                        and settlement.createtime between #{from} and #{to}
                  ) t
             group by t.projectname
         ) t2
    where t1.projectname = t2.projectname
    order by sumprice, countprojectname


    </select>


</mapper>

