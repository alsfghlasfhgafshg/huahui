<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aaa.huahui.repository.AnalysisTableRepository">


    <select id="selectCustomerHands" resultType="com.aaa.huahui.vo.CustomerHandsVO">
        select customer,createtime,projectname,money,times
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and category in ('美容','美体','仪器') and createtime between #{starttime} and #{endtime}
        union all
        select '总计' as customer,''as createtime,''as projectname,sum(money) as money,sum(times) as times
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and category in ('美容','美体','仪器') and createtime between #{starttime} and #{endtime}
    </select>

    <select id="selectCustomerCash" resultType="com.aaa.huahui.vo.CustomerHandsVO">
        select customer,createtime,projectname,money,times
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and consumptioncategory in ('现金卡','现金产品','现金实操') and createtime between #{starttime} and #{endtime}
        union all
        select '总计' as customer,''as createtime,''as projectname,sum(money) as money,sum(times) as times
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and consumptioncategory in ('现金卡','现金产品','现金实操') and createtime between #{starttime} and #{endtime}
    </select>

    <select id="downtoStoreTimes" resultType="java.util.HashMap">
       select customer,count(customer) as times
       from settlementnew
       where shopid=#{shopid} and createtime between #{start} and  #{end}
       group by customer
       order by times desc;
    </select>

    <select id="actualMoney" resultType="java.util.HashMap">
       select * from(
       select customer,sum(money) as smoney
       from settlementnew
       where shopid=#{shopid} and consumptioncategory in ('卡扣产品','卡扣实操','现金产品','现金实操') and createtime between #{start} and  #{end}
       group by customer) t
       union all
       select '总计' as customer,sum(money) as smoney
       from settlementnew
       where shopid=#{shopid} and consumptioncategory in ('卡扣产品','卡扣实操','现金产品','现金实操') and createtime between #{start} and  #{end}
    </select>

    <select id="downtoStorePercent" resultType="java.util.HashMap">
        select times, count(*) con
        from (
        select customer, count(customer) as times
        from settlementnew
        where shopid = #{shopid}
        and settlementnew.createtime between #{start} and  #{end}
        group by customer
        order by times) t
        group by times
        having times &lt; 5
        union all
        select 5 times, count(*)
        from (
        select times, count(*) con
        from (select customer, count(customer) as times
        from settlementnew
        where shopid = #{shopid}
        and settlementnew.createtime between #{start} and  #{end}
        group by customer
        order by times) t
        group by times
        having times >= 5
        ) tt
    </select>

</mapper>