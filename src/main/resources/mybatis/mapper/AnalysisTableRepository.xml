<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aaa.huahui.repository.AnalysisTableRepository">


    <select id="selectCustomerHands" resultType="com.aaa.huahui.vo.CustomerHandsVO">
        select * from(
        select customer,
       if(sum(t1 + t2 + t3) = 0, "睡眠客",
          if(sum(t1 + t2 + t3) = 2, "活客", if(sum(t1 + t2 + t3) = 3, "有效客", "其它"))) as status
    from (
       select customer,
                       if(createtime between date_sub(now(), INTERVAL 30 DAY) and now(), 1, 0) as t1,
                       if(createtime between date_sub(now(), INTERVAL 60 DAY) and date_sub(now(), INTERVAL 30 DAY), 1,
                          0)                                                                   as t2,
                       if(createtime between date_sub(now(), INTERVAL 90 DAY) and date_sub(now(), INTERVAL 60 DAY), 1,
                          0)                                                                   as t3
       from settlementnew
      where customer=#{customer}
     ) t)aa
     inner join (
        select customer,createtime,projectname,money,times,hand
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and category in ('美容','美体','仪器') and createtime between #{starttime} and #{endtime}
        union all
        select '总计' as customer,''as createtime,''as projectname,sum(money) as money,sum(times) as times,sum(hand) as hand
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and category in ('美容','美体','仪器') and createtime between #{starttime} and #{endtime}) bb where aa.customer=bb.customer
    </select>

    <select id="selectCustomerCash" resultType="com.aaa.huahui.vo.CustomerHandsVO">
        select * from(
        select customer,
       if(sum(t1 + t2 + t3) = 0, "睡眠客",
          if(sum(t1 + t2 + t3) = 2, "活客", if(sum(t1 + t2 + t3) = 3, "有效客", "其它"))) as status
    from (
       select customer,
                       if(createtime between date_sub(now(), INTERVAL 30 DAY) and now(), 1, 0) as t1,
                       if(createtime between date_sub(now(), INTERVAL 60 DAY) and date_sub(now(), INTERVAL 30 DAY), 1,
                          0)                                                                   as t2,
                       if(createtime between date_sub(now(), INTERVAL 90 DAY) and date_sub(now(), INTERVAL 60 DAY), 1,
                          0)                                                                   as t3
       from settlementnew
      where customer=#{customer}
     ) t)aa
     inner join (
        select customer,createtime,projectname,money,times,hand
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and consumptioncategory in ('现金卡','现金产品','现金实操') and createtime between #{starttime} and #{endtime}
        union all
        select '总计' as customer,''as createtime,''as projectname,sum(money) as money,sum(times) as times,sum(hand) as hand
        from settlementnew
        where customer=#{customer} and shopid=#{shopid} and consumptioncategory in ('现金卡','现金产品','现金实操') and createtime between #{starttime} and #{endtime}) bb where aa.customer=bb.customer
    </select>

    <select id="selectAllCustomer" resultType="com.aaa.huahui.vo.CustomerHandsVO">
        select * from(
        select customer,
               if(sum(t1 + t2 + t3) = 0, "睡眠客",
                  if(sum(t1 + t2 + t3) = 2, "活客", if(sum(t1 + t2 + t3) = 3, "有效客", "其他"))) as status
        from (
               select distinct customer,
                               if(createtime between date_sub(now(), INTERVAL 30 DAY) and now(), 1, 0) as t1,
                               if(createtime between date_sub(now(), INTERVAL 60 DAY) and date_sub(now(), INTERVAL 30 DAY), 1,
                                  0)                                                                   as t2,
                               if(createtime between date_sub(now(), INTERVAL 90 DAY) and date_sub(now(), INTERVAL 60 DAY), 1,
                                  0)                                                                   as t3
               from settlementnew
             ) t
        group by customer) aa
        inner join(
        select customer,createtime,projectname,money,times,hand
        from settlementnew
        where shopid=#{shopid} and createtime between #{start} and #{end}
        order by createtime desc) bb on aa.customer=bb.customer
    </select>

    <select id="downtoStoreTimes" resultType="java.util.HashMap">
       select customer,count(customer) as times
       from settlementnew
       where shopid=#{shopid} and createtime between #{start} and  #{end}
       group by customer
       order by times desc;
    </select>

    <select id="actualMoney" resultType="java.util.HashMap">
       select * from(
       select customer,sum(money) as smoney
       from settlementnew
       where shopid=#{shopid} and consumptioncategory in ('卡扣产品','卡扣实操','现金产品','现金实操') and createtime between #{start} and  #{end}
       group by customer) t
       union all
       select '总计' as customer,sum(money) as smoney
       from settlementnew
       where shopid=#{shopid} and consumptioncategory in ('卡扣产品','卡扣实操','现金产品','现金实操') and createtime between #{start} and  #{end}
    </select>

    <select id="downtoStorePercent" resultType="java.util.HashMap">
        select times, cast(sum(con) as int) con from (
        select times, count(*) con
        from (
        select customer, count(customer) as times
        from settlementnew
        where shopid = #{shopid}
        and settlementnew.createtime between #{start} and  #{end}
        group by customer
        order by times) t
        group by times
        having times &lt; 5
        union all
        select 5 times, count(*)
        from (
        select times, count(*) con
        from (select customer, count(customer) as times
        from settlementnew
        where shopid = #{shopid}
        and settlementnew.createtime between #{start} and  #{end}
        group by customer
        order by times) t
        group by times
        having times >= 5
        ) tt
        union select 1 times,0 con
        union
        select 2 times,0 con
        union
        select 3 times,0 con
        union
        select 4 times,0 con)tt group by times
    </select>

</mapper>